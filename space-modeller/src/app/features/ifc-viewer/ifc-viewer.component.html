<div class="viewer-container">
  <!-- 3D Canvas -->
  <canvas 
    #canvas 
    class="viewer-canvas"
    role="application"
    aria-label="3D viewport for IFC model visualization"
  ></canvas>

  <!-- Left Sidebar -->
  <aside 
    class="sidebar" 
    [class.collapsed]="isSidebarCollapsed()"
    role="complementary"
    aria-label="Viewer controls sidebar"
  >
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      @if (!isSidebarCollapsed()) {
        <h2 class="sidebar-title">Controls</h2>
      }
      <button
        class="sidebar-toggle"
        (click)="toggleSidebar()"
        [attr.aria-label]="isSidebarCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
        [title]="isSidebarCollapsed() ? 'Expand sidebar' : 'Collapse sidebar'"
      >
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width="20" 
          height="20" 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          stroke-width="2" 
          stroke-linecap="round" 
          stroke-linejoin="round"
          [class.rotate]="isSidebarCollapsed()"
        >
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
    </div>

    <!-- Sidebar Content -->
    @if (!isSidebarCollapsed()) {
      <div class="sidebar-content">
        <!-- File Input (hidden) -->
        <input
          #fileInput
          type="file"
          accept=".ifc"
          (change)="onFileSelected($event)"
          class="file-input"
          aria-label="Select IFC file"
        />

        <!-- Camera View Section -->
        <div class="sidebar-section">
          <h3 class="section-title">Camera View</h3>
          <div class="camera-select-wrapper">
            <select
              class="camera-select"
              [value]="cameraType()"
              (change)="onCameraChange($event)"
              aria-label="Select camera view type"
              title="Choose between 3D perspective or 2D orthographic view"
            >
              @for (option of cameraOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
            <svg class="select-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <p class="sidebar-hint">Switch between 3D and 2D views</p>
        </div>

        <!-- Import Section -->
        <div class="sidebar-section">
          <h3 class="section-title">Import</h3>
          <button
            class="sidebar-button primary"
            (click)="openFilePicker()"
            [disabled]="isLoading()"
            aria-label="Import IFC file"
            title="Import IFC file"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>Import IFC</span>
          </button>
          <p class="sidebar-hint">Load your IFC model file</p>
        </div>

        <!-- Export Section -->
        <div class="sidebar-section">
          <h3 class="section-title">Export</h3>
          <button
            class="sidebar-button secondary"
            (click)="downloadFragment()"
            [disabled]="!currentModel()?.fragmentUuid || isLoading()"
            aria-label="Download as .frag"
            title="Download as .frag"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span>Download .frag</span>
          </button>
          <p class="sidebar-hint">Export as fragment file</p>
        </div>

        <!-- Model Info Section -->
        @if (currentModel(); as model) {
          <div class="sidebar-section">
            <h3 class="section-title">Model Info</h3>
            <div class="model-info">
              <div class="info-row">
                <span class="info-label">Name:</span>
                <span class="info-value">{{ model.name }}</span>
              </div>
              @if (model.status === 'loading' || model.status === 'processing') {
                <div class="info-row">
                  <span class="info-label">Progress:</span>
                  <span class="info-value">{{ model.progress.toFixed(1) }}%</span>
                </div>
              }
              @if (model.status === 'loaded' && model.stats) {
                <div class="info-row">
                  <span class="info-label">Fragments:</span>
                  <span class="info-value">{{ model.stats.fragmentCount }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- IFC Class Filter Section -->
        <div class="sidebar-section filter-section">
          <app-ifc-class-filter />
        </div>
      </div>
    }
  </aside>

  <!-- Loading Overlay -->
  @if (isLoading()) {
    <div class="loading-overlay" role="status" aria-live="polite">
      <div class="loading-spinner"></div>
      <div class="loading-text">
        Loading IFC file...
        @if (currentModel()?.progress; as progress) {
          <span>{{ progress.toFixed(1) }}%</span>
        }
      </div>
    </div>
  }

  <!-- Error Message -->
  @if (currentModel()?.error; as error) {
    <div class="error-message" role="alert">
      <strong>Error</strong>
      {{ error.message }}
    </div>
  }

  <!-- Controls Guide (Help Tooltip) --> 
  <div class="controls-guide" role="tooltip" aria-label="Navigation controls guide">
    <div class="controls-guide-header">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
      <span>Controls</span>
    </div>
    <div class="controls-guide-items">
      <div class="control-item">
        <kbd>Left Click + Drag</kbd>
        <span>Rotate</span>
      </div>
      <div class="control-item">
        <kbd>Right Click + Drag</kbd>
        <span>Pan</span>
      </div>
      <div class="control-item">
        <kbd>Scroll Wheel</kbd>
        <span>Zoom</span>
      </div>
    </div>
  </div>
</div>

